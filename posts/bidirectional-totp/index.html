<!DOCTYPE html>






























<html
  class="not-ready text-sm lg:text-base"
  style="--bg: #faf6f1"
  lang="en-us"
>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />
  
    
    <title>Bi-Directional Authentication with TOTP - Juniperspring</title>
  
    
    <meta name="theme-color" />
  
    
    
    
    <meta name="description" content="Image sourced from Wikimedia, attributed according to the Creative Commons Attribution 2.0 Generic license.
Motivation Time-Based One Time Password (TOTP) authentication is extremely beneficial. It lets you quickly add two‚Äëfactor authentication (2FA) to online accounts according to a simple and open standard. Simply scan a QR code into a TOTP app like Aegis. As long as you have access to your phone, you can then use the TOTP app to generate 2FA codes whenever need be." />
    <meta name="author" content="Eric McDonald" />
    
  
    
    
    
    
    
    
    <link rel="preload stylesheet" as="style" href="https://juniperspring.xyz/main.min.css" />
  
    
    <script
      defer
      src="https://juniperspring.xyz/highlight.min.js"
      onload="hljs.initHighlightingOnLoad();"
    ></script>
    
  
    
     
    <link rel="preload" as="image" href="https://juniperspring.xyz/theme.png" />
  
    
    
    
    
  
    
    <link rel="preload" as="image" href="https://juniperspring.xyz/github.svg" />
    
    <link rel="preload" as="image" href="https://juniperspring.xyz/rss.svg" />
    
    
  
    
    
    <link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.css"
  integrity="sha384-3UiQGuEI4TTMaFmGIZumfRPtfKQ3trwQE2JgosJxCnGmQpL/lJdjpcHkaaFwHlcI"
  crossorigin="anonymous"
/>
<script
  defer
  src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/katex.min.js"
  integrity="sha384-G0zcxDFp5LWZtDuRMnBkk3EphCK1lhEf4UEyEM693ka574TZGwo4IWwS6QLzM/2t"
  crossorigin="anonymous"
></script>
<script
  defer
  src="https://cdn.jsdelivr.net/npm/katex@0.16.7/dist/contrib/auto-render.min.js"
  integrity="sha384-+VBxd3r6XgURycqtZ117nYw44OOcIax56Z4dCRWbxyPt0Koah1uHoK0o4+/RRE05"
  crossorigin="anonymous"
  onload="renderMathInElement(document.body);"
></script>

    
    
    
  
    
    <link rel="icon" href="https://juniperspring.xyz/favicon.ico" />
    <link rel="apple-touch-icon" href="https://juniperspring.xyz/apple-touch-icon.png" />
  
    
    <meta name="generator" content="Hugo 0.112.0">
  
    
    
  
    
    
    
    
    
    
    
    <meta property="og:title" content="Bi-Directional Authentication with TOTP" />
<meta property="og:description" content="Authentication is a two-way street." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://juniperspring.xyz/posts/bidirectional-totp/" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2023-01-21T00:00:00+00:00" />
<meta property="article:modified_time" content="2023-01-21T00:00:00+00:00" />

    
    <meta itemprop="name" content="Bi-Directional Authentication with TOTP">
<meta itemprop="description" content="Authentication is a two-way street."><meta itemprop="datePublished" content="2023-01-21T00:00:00+00:00" />
<meta itemprop="dateModified" content="2023-01-21T00:00:00+00:00" />
<meta itemprop="wordCount" content="1084">
<meta itemprop="keywords" content="mfa,security,totp,cryptography," />
    
    <meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Bi-Directional Authentication with TOTP"/>
<meta name="twitter:description" content="Authentication is a two-way street."/>

    
    
    <script defer data-domain="juniperspring.com" src="https://plausible.io/js/script.js"></script>
</head>

  <body class="text-black duration-200 ease-out dark:text-white">
    <header class="mx-auto flex h-[5rem] max-w-3xl px-8 lg:justify-center">
  <div class="relative z-50 mr-auto flex items-center">
    <a
      class="-translate-x-[1px] -translate-y-0.5 text-3xl font-bold site-title"
      href="https://juniperspring.xyz/"
      >Juniperspringüå±</a
    >
    <div
      class="btn-dark text-[0] ml-6 h-6 w-6 shrink-0 cursor-pointer [background:url(./theme.png)_left_center/_auto_theme('spacing.6')_no-repeat] [transition:_background-position_0.4s_steps(5)] dark:[background-position:right]"
      role="button"
      aria-label="Dark"
    ></div>
  </div>

  <div
    class="btn-menu relative z-50 -mr-8 flex h-[5rem] w-[5rem] shrink-0 cursor-pointer flex-col items-center justify-center gap-2.5 lg:hidden"
    role="button"
    aria-label="Menu"
  ></div>

  
  <script>
    
    const htmlClass = document.documentElement.classList;
    setTimeout(() => {
      htmlClass.remove('not-ready');
    }, 10);

    
    const btnMenu = document.querySelector('.btn-menu');
    btnMenu.addEventListener('click', () => {
      htmlClass.toggle('open');
    });

    
    const metaTheme = document.querySelector('meta[name="theme-color"]');
    const lightBg = `"#faf6f1"`.replace(/"/g, '');
    const setDark = (isDark) => {
      metaTheme.setAttribute('content', isDark ? '#000' : lightBg);
      htmlClass[isDark ? 'add' : 'remove']('dark');
      localStorage.setItem('dark', isDark);
    };

    
    const darkScheme = window.matchMedia('(prefers-color-scheme: dark)');
    if (htmlClass.contains('dark')) {
      setDark(true);
    } else {
      const darkVal = localStorage.getItem('dark');
      setDark(darkVal ? darkVal === 'true' : darkScheme.matches);
    }

    
    darkScheme.addEventListener('change', (event) => {
      setDark(event.matches);
    });

    
    const btnDark = document.querySelector('.btn-dark');
    btnDark.addEventListener('click', () => {
      setDark(localStorage.getItem('dark') !== 'true');
    });
  </script>

  <div
    class="nav-wrapper fixed inset-x-0 top-full z-40 flex h-full select-none flex-col justify-center pb-16 duration-200 dark:bg-black lg:static lg:h-auto lg:flex-row lg:!bg-transparent lg:pb-0 lg:transition-none"
  >
    
    

    
    <nav
      class="mt-12 flex justify-center space-x-10 dark:invert lg:ml-12 lg:mt-0 lg:items-center lg:space-x-6"
    >
      
      <a
        class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./github.svg)"
        href="https://github.com/librick"
        target="_blank"
        rel="me"
      >
        github
      </a>
      
      <a
        class="h-8 w-8 text-[0] [background:var(--url)_center_center/cover_no-repeat] lg:h-6 lg:w-6"
        style="--url: url(./rss.svg)"
        href="https://juniperspring.xyz/index.xml"
        target="_blank"
        rel="alternate"
      >
        rss
      </a>
      
    </nav>
    
  </div>
</header>


    <main
      class="prose prose-neutral relative mx-auto min-h-[calc(100%-10rem)] max-w-3xl px-8 pb-24 pt-16 dark:prose-invert"
    >
      

<article>
  <header class="mb-20">
    <h1 class="!my-0 pb-2.5">Bi-Directional Authentication with TOTP</h1>

    
    <div class="text-sm opacity-60">
      
      <time>Jan 21, 2023</time>
      
      
      
      
    </div>
    
  </header>

  <section><p><img src="berlin-clock.jpg" alt="Mengenlehreuhr" title="Mengenlehreuhr, Berlin">
Image sourced from <a href="https://commons.wikimedia.org/wiki/File:Berlin_-_Mengenlehreuhr_am_Europa-Center.jpg">Wikimedia</a>,
attributed according to the Creative Commons Attribution 2.0 Generic license.</p>
<h2 id="motivation">Motivation</h2>
<p>Time-Based One Time Password (TOTP) authentication is extremely beneficial.
It lets you quickly add two‚Äëfactor authentication (2FA) to online accounts according
to a simple and open standard. Simply scan a QR code into a TOTP app like <a href="https://github.com/beemdevelopment/Aegis">Aegis</a>.
As long as you have access to your phone, you can then use the TOTP app to generate 2FA codes whenever need be.
No risk of <a href="https://en.wikipedia.org/wiki/SIM_swap_scam">simswapping</a>, no need for SMS reception or a phone number, and no need for proprietary 2FA apps.</p>
<p><strong>But TOTP as it&rsquo;s currently widely implemented has a shortcoming; it doesn&rsquo;t prevent phishing attacks.</strong>
Click a link in an email that redirects to a phishing website; the phishing website mimics one of your favorite websites.
You think it&rsquo;s the legitimate website, so you enter your username, password, and TOTP code.
The attacker behind the phishing website now has everything they need to sign in to the legitimate website on your behalf without your consent.
Even though you have TOTP‚Äëbased 2FA enabled, you can still be phished.</p>
<h2 id="the-problem">The Problem</h2>
<p>The problem in the above scenario is that authentication is only actually being done one way.
Existing TOTP implementations allow users to authenticate to websites (think &ldquo;I&rsquo;m the website google.com, is this person really John Smith?&rdquo;).
Existing TOTP implementations <em>don&rsquo;t</em> authenticate websites to users (think &ldquo;I&rsquo;m John Smith, is this website really google.com?&rdquo;).</p>
<h2 id="bi-directional-alternative">Bi-Directional Alternative</h2>
<p>Imagine the scenario where, in addition to asking you for your TOTP code (let&rsquo;s call this <code>z</code>), a website also provided you with its own TOTP code (let&rsquo;s call this <code>z'</code>).
Within your authenticator app, you&rsquo;d select the desired website from a list of stored websites.
But rather than being shown a TOTP code right away (<code>z</code>), you&rsquo;d be prompted for the TOTP code provided from the website (<code>z'</code>).</p>
<p>If the website is a phishing website, they can&rsquo;t produce valid TOTP codes <code>z</code> or <code>z'</code>.
Your authenticator app would check that the TOTP code provided by the website (<code>z'</code>) is valid.
The legitimate website would check that the TOTP code provided by your authenticator app (<code>z</code>) is valid.</p>
<p>If the code <code>z'</code> is NOT valid, the authenticator app knows something is wrong, and would show a large error message indicating that you may be interacting with a phishing website.
At this point, you could change your password on the legitimate site and report the phishing attempt.</p>
<p>If the code <code>z'</code> is valid, the authenticator app would provide you with the usual TOTP code <code>z</code> and you would sign in as usual.
If the code <code>z'</code> is NOT valid, the authenticator app would never provide you with the TOTP code required by the legitimate website.</p>
<h2 id="bi-directional-authentication-in-the-rfc">Bi-Directional Authentication in the RFC</h2>
<p>I mused over this for long enough that I exhausted the TOTP and HOTP Wikipedia articles and went on to read the RFCs.
There are (at least) two main standards related to TOTP.
<a href="https://datatracker.ietf.org/doc/html/rfc4226">RFC 4226</a> defines a more generic HMAC‚ÄëBased OTP algorithm (HOTP).
<a href="https://datatracker.ietf.org/doc/html/rfc6238">RFC 6238</a> defines the TOTP algorithm based on the HOTP algorithm.
On page 14 of <a href="https://datatracker.ietf.org/doc/html/rfc4226">RFC 4226</a>, I found this gem:</p>
<blockquote>
<p>Interestingly enough, the HOTP client could also be used to<br>
authenticate the validation server, claiming that it is a genuine<br>
entity knowing the shared secret.</p>
<p>Since the HOTP client and the server are synchronized and share the<br>
same secret (or a method to recompute it), a simple 3-pass protocol<br>
could be put in place:<br>
1- The end user enter the TokenID and a first OTP value OTP1;<br>
2- The server checks OTP1 and if correct, sends back OTP2;<br>
3- The end user checks OTP2 using his HOTP device and if correct,<br>
uses the web site.</p>
</blockquote>
<p>In other words, the writers of the HOTP RFC considered this as a possibility but nothing (as far as I know) ever came of it.</p>
<h2 id="implementation-ideas">Implementation Ideas</h2>
<p>I&rsquo;ve come up with two back-of-the-envelope implementation ideas that seem like they&rsquo;d work given minimal extension of the existing RFCs.</p>
<h3 id="the-straightforward-way---generate-two-keys">The Straightforward Way - Generate Two Keys</h3>
<p>The most straightforward way (in my opinion) to implement bi‚Äëdirectional TOTP would be to generate two shared keys on a website for each new 2FA enrollment.
Call these keys $$k, k&rsquo;$$</p>
<ul>
<li><code>k</code> would be used for (the usual) user‚Äëto‚Äëwebsite authentication</li>
<li><code>k'</code> would be used for (the new) website‚Äëto‚Äëuser authentication</li>
</ul>
<p>One drawback to this approach is that it includes the network transmission of <code>k'</code> during enrollment.
Further, this requires storing <code>k'</code> for every 2FA enrollment, increasing storage costs.</p>
<h3 id="the-simple-way---key-derivation">The Simple(?) Way - Key Derivation</h3>
<p>Rather than generate a new key <code>k'</code> just for website-to-client authentication, it could be derived from <code>K</code>.
For example, implementations could use a <a href="https://en.wikipedia.org/wiki/Key_derivation_function">key derivation function</a>
such as Argon2 or PBKDF2, taking as inputs <code>K</code> and some salt which is fixed for the protocol.</p>
<p>The biggest advantages to this approach is that it negates the need for network transmission of <code>k'</code> upon enrollment.
It also allows for finer-grained time/value tradeoffs to be made regarding when <code>k'</code> is derived and stored.
The drawback is added complexity and an increased implementation attack surface.</p>
<h2 id="conclusion">Conclusion</h2>
<p>Bi‚Äëdirectional authentication is only mentioned in the HOTP RFC, not the TOTP RFC.
Neither RFC 4226 nor 6238 include the word &ldquo;phishing&rdquo; and they were published in 2005 and 2011, respectively.
I would argue that, given that phishing attacks are still prevalent in 2023, we should revisit bi‚Äëdirectional authentication in TOTP.
I&rsquo;d love to see a pull request to support this in one of the major open source TOTP implementations.</p>
<h2 id="appendix-accessibility">Appendix: Accessibility</h2>
<p>TOTP limits accessibility by using short timeouts (30 seconds by default).
Adding a second code implies a twofold increase in the amount of time required by a user to authenticate to a service.
Further, TOTP codes aren&rsquo;t intuitive to a non-technical audience. In my opinion, this is evidenced by a lack of wider adoption. Adding a second code to the mix only increases the potential for confusion.</p>
<p>I understand the absence of a widely-implemented bi-directional TOTP standard in light of these constraints.</p>
<h2 id="appendix-phishing-vs-totp-timeouts">Appendix: Phishing vs TOTP Timeouts</h2>
<p>Technically, because TOTP codes expire (by default) in 30 seconds,
any phishing attack would have to prompt the user for their TOTP code, receive the response, and have it accepted by the legitimate website
on behalf of the attacker within 30 seconds.</p>
<p>In practice, I don&rsquo;t see this as a limiting factor in most phishing attacks.
Also, specific TOTP code expiration times are an implementation detail;
I don&rsquo;t think they should be relied upon to prevent phishing attacks.</p>
</section>

  
  
  <footer class="mt-12 flex flex-wrap">
     
    <a
      class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-2 no-underline dark:bg-white/[8%]"
      href="https://juniperspring.xyz/tags/mfa"
      >mfa</a
    >
     
    <a
      class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-2 no-underline dark:bg-white/[8%]"
      href="https://juniperspring.xyz/tags/security"
      >security</a
    >
     
    <a
      class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-2 no-underline dark:bg-white/[8%]"
      href="https://juniperspring.xyz/tags/totp"
      >totp</a
    >
     
    <a
      class="mb-1.5 mr-1.5 rounded-lg bg-black/[3%] px-5 py-2 no-underline dark:bg-white/[8%]"
      href="https://juniperspring.xyz/tags/cryptography"
      >cryptography</a
    >
    
  </footer>
  

  
  
  
  <nav class="mt-24 flex rounded-lg bg-black/[3%] text-lg dark:bg-white/[8%]">
    
    <a
      class="flex w-1/2 items-center rounded-l-md p-6 pr-3 no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]"
      href="https://juniperspring.xyz/posts/rhodes-tower/"
      ><span class="mr-1.5">‚Üê</span><span>Rhodes Tower, Four Dead in Ohio</span></a
    >
    
    
    <a
      class="ml-auto flex w-1/2 items-center justify-end rounded-r-md p-6 pl-3 no-underline hover:bg-black/[2%] dark:hover:bg-white/[3%]"
      href="https://juniperspring.xyz/posts/novak-v-parma/"
      ><span>Parma Police Eat Dog Shit</span><span class="ml-1.5">‚Üí</span></a
    >
    
  </nav>
  

  
  

  
  
</article>


    </main>

    <footer class="mx-auto flex-col h-[5rem] max-w-3xl px-8 text-[0.9em] opacity-60">
  <div>You got a sweet voice, child / Why don't you use it? - Morby</div>
  <div class="mr-auto">
    &copy; 2023,
    <a class="link" href="https://juniperspring.xyz">MIT License</a>
  </div>
</footer>

  </body>
</html>
